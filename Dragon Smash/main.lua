map = {
   { 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4 }, 
   { 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4 },
   { 4, 4, 4, 4, 4, 1, 1, 4, 4, 4, 4, 4, 1, 1, 4, 4, 4, 4, 4 },
   { 4, 4, 4, 4, 4, 1, 4, 4, 4, 1, 4, 4, 4, 1, 4, 4, 4, 4, 4 },
   { 4, 4, 4, 1, 4, 4, 4, 4, 4, 0, 4, 4, 4, 4, 4, 1, 4, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 0, 0, 2, 2, 2, 2, 2, 2, 2, 0, 0, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 2, 1, 2, 2, 2, 1, 2, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 2, 1, 2, 2, 3, 2, 2, 1, 2, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 2, 1, 2, 2, 3, 3, 3, 2, 2, 1, 2, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4 },
   { 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4 },
   { 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4 },
   { 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4 },
}

battle = {
   {  1, 1, 1, 1, 1, 1, 1, 1, 1 },
   {  1, 0, 0, 0, 0, 0, 0, 0, 1 },
   {  1, 0, 0, 0, 0, 0, 0, 0, 1 },
   {  1, 0, 0, 0, 0, 0, 0, 0, 1 },
   {  1, 0, 0, 0, 0, 0, 0, 0, 1 },
   {  1, 0, 0, 0, 0, 0, 0, 0, 1 },
   {  1, 0, 0, 0, 0, 0, 0, 0, 1 },
   {  1, 0, 0, 0, 0, 0, 0, 0, 1 },
   {  1, 1, 1, 1, 1, 1, 1, 1, 1 },
}

-------AT-LEVEL------{ 2    3    4    5    6     7     8     9    10    11    12    13    14 }
experienceRequired = { 5,  10,  20,  40,  70,  110,  160,  220,  290,  370,  460,  560,  600 }
attacksGained      = { 1,   1,   2,   2,   3,    3,    4,    4,    5,    5,    6,    6,    7 }
defenseGained      = { 1,   1,   1,   2,   2,    2,    3,    3,    3,    4,    4,    4,    5 }
healthGained       = { 1,   1,   2,   2,   3,    3,    4,    4,    5,    5,    6,    6,    7 }
magicGained        = { 1,   1,   1,   2,   2,    2,    3,    3,    3,    4,    4,    4,    5 }
-------AT-LEVEL------{ 2    3    4    5    6     7     8     9    10    11    12    13    14 }

love.window.setTitle("Dragon Smash")
love.window.setMode(744, 744)
love.window.setPosition(440, 40)
defaultFont = love.graphics.newFont(10)

TILE_SIZE = 34
SCREEN_SIZE = 9

hero = {}
hero.imageLeft = love.graphics.newImage("hero1.png")
hero.imageRight = love.graphics.newImage("hero2.png")
hero.imageSwitch = 0
hero.imageTimer = 0
hero.healthMax = 0
hero.magicMax = 0
hero.attacks = 0
hero.defense = 0
hero.experience = 0
hero.level = 1
hero.gold = 0

slime = {}
slime.image = love.graphics.newImage("slime.png")
slime.name = "Slime"

redSlime = {}
redSlime.image = love.graphics.newImage("redslime.png")
redSlime.name = "Red Slime"

dracky = {}
dracky.image = love.graphics.newImage("dracky.png")
dracky.name = "Dracky"

greenDragon = {}
greenDragon.image = love.graphics.newImage("greenDragon.png")
greenDragon.name = "Green Dragon"

enemies = {}
enemies[1] = slime
enemies[2] = redSlime
enemies[3] = dracky
enemies[4] = greenDragon
enemy = 0

mode = 0
steps = 0
encounter = 0

tile = {}
for i = 0, 4 do
   tile[i] = love.graphics.newImage("tile"..i..".png")
end
onTile = 0
mapX = 5
mapY = 0
mapW = 19
mapH = 40

battleFrame = love.graphics.newImage("battleFrame.png")
battleMenu = {"Attack", "Magic", "Run"}
command = 0
worldMenu = {"Heal", "Talk", "End"}
selection = 0
cursorBase = 75
cursorHead = 80

function love.load()
   hero.imageSwitch = 0
   hero.imageTimer = 0
   hero.healthMax = love.math.random(10,12)
   hero.health = hero.healthMax
   hero.magicMax = love.math.random(10,12)
   hero.magics = hero.magicMax
   hero.attacks = love.math.random(5,7)
   hero.defense = love.math.random(1,2)
   resetEnemies()
end

function atTile()
   onTile = map[mapY+5][mapX+5]
end

function resetSelector()
   command = 0
   selection = 0
   cursorBase = 75
   cursorHead = 80
end

function talk()
   if mapX == 5 and mapY == 0 then
      hero.magics = hero.magicMax
      print("\nThy magics are restored!")
   else
      print("\nNobody present")
   end
end

function resetEnemies()
   steps = 0
   encounter = love.math.random(4,24)

   slime.health = love.math.random(6,8)
   slime.attacks = love.math.random(2,4)
   slime.level = love.math.random(2,4)
   slime.gold = love.math.random(2,4)

   redSlime.health = love.math.random(8,10)
   redSlime.attacks = love.math.random(4,6)
   redSlime.level = love.math.random(4,6)
   redSlime.gold = love.math.random(4,6)

   dracky.health = love.math.random(10,12)
   dracky.attacks = love.math.random(6,8)
   dracky.level = love.math.random(6,8)
   dracky.gold = love.math.random(6,8)

   greenDragon.health = love.math.random(60,80)
   greenDragon.attacks = love.math.random(50,60)
   greenDragon.level = love.math.random(50,60)
   greenDragon.gold = love.math.random(50,60)
end

function levelUp()
   if hero.experience >= experienceRequired[hero.level] then
      hero.attacks = hero.attacks + attacksGained[hero.level]
      hero.defense = hero.defense + defenseGained[hero.level]
      hero.healthMax = hero.healthMax + healthGained[hero.level]
      hero.magicMax = hero.magicMax + magicGained[hero.level]

      print("\nThy level ")
      print("increases to "..(hero.level + 1).."!")
      print("Thy Attack")
      print("increases by "..attacksGained[hero.level].."!")
      print("Thy Defense")
      print("increases by "..defenseGained[hero.level].."!")
      print("Thy maximum Hits")
      print("increases by "..healthGained[hero.level].."!")
      print("Thy maximum Magics")
      print("increases by "..magicGained[hero.level].."!")
      
      hero.level = hero.level + 1
   end
end

function enemyAttack()
   damage = enemies[enemy].attacks - hero.defense
   if damage <= 0 then
      damage = 1
   end
   hero.health = hero.health - damage
   print("\nThe "..enemies[enemy].name.." attacks!")
   print("Thy Hit decreased by "..damage..".")
end

function castHeal()
   if hero.magics >= 4 then
      if hero.health < hero.healthMax then
         life = love.math.random(20,25)
         limit = hero.healthMax - hero.health
         if life > limit then
            life = limit
         end
         hero.magics = hero.magics - 4
         hero.health = hero.health + life
         print("\nHero chanted the spell")
         print("of HEAL.")             
      else 
         print("\nThy hits cannot be raised.")
      end
   else
      print("\nThy MP is too low.")
   end
end

function battleEvents()
   if command == 0 then
      enemies[enemy].health = enemies[enemy].health - hero.attacks
      print("\nHero attacks!")
      print("The "..enemies[enemy].name.."'s Hit Points")
      print("have been reduced by "..hero.attacks..".")
      if enemies[enemy].health > 0 then
         enemyAttack()
      else
         hero.experience = hero.experience + enemies[enemy].level
         hero.gold = hero.gold + enemies[enemy].gold
         print("\nThou hast done well in")
         print("defeating the "..enemies[enemy].name..".")
         print("\nThy Experience")
         print("increases by "..enemies[enemy].level..".")
         print("\nThy GOLD")
         print("increases by "..enemies[enemy].gold..".")
         levelUp()
         resetEnemies()
         mode = 0
      end
   elseif command == 1 then
      castHeal()
      enemyAttack() 
   elseif command == 2 then
      print("\nHero started to run away.")
      resetEnemies()
      mode = 0
   end
   if hero.health <= 0 then
      print("\nThou art dead.")
      love.event.quit()
   else
      print("\nCommand?")
   end
   resetSelector()
end

function worldEvents()
   if steps == encounter then
      if onTile == 2 then
         enemy = love.math.random(2,3)
      elseif onTile == 3 then
         enemy = 4
      else
         enemy = love.math.random(1,2)
      end
      resetSelector()
      print("\nA "..enemies[enemy].name.." draws near!")
      print("Command?")
      mode = 1
   end
end

function menuEvents()
   if selection == 0 then
      castHeal()
   elseif selection == 1 then
      talk()
   end
   resetSelector()
   mode = 0
end

function love.keypressed(key)
   if mode == 0 then
      if key == ('w') then
         if mapY > 0 then
            mapY = mapY - 1
            atTile()
            if onTile ~= 1 and onTile ~= 4 then
               steps = steps + 1
               worldEvents()
            else
               mapY = mapY + 1
            end
         end
      elseif key == ('s') then
         if mapY < mapH-SCREEN_SIZE then
            mapY = mapY + 1
            atTile()
            if onTile ~= 1 and onTile ~= 4 then
               steps = steps + 1
               worldEvents()
            else
               mapY = mapY - 1
            end
         end
      elseif key == ('a')  then
         if mapX > 0 then
            mapX = mapX - 1
            atTile()
            if onTile ~= 1 and onTile ~= 4 then
               steps = steps + 1
               worldEvents()
            else
               mapX = mapX + 1
            end
         end
      elseif key == ('d') then
         if mapX < mapW-SCREEN_SIZE then
            mapX = mapX + 1
            atTile()
            if onTile ~= 1 and onTile ~= 4 then
               steps = steps + 1
               worldEvents()
            else
               mapX = mapX - 1
            end
         end
      elseif key == ('return') then
         mode = 2
         return
      end
   elseif mode == 1 then
      if key == ('a') then
         if command > 0 then
            cursorBase = cursorBase - 84
            cursorHead = cursorHead - 84
            command = command - 1
         end
      elseif key == ('d') then
         if command < 2 then
            cursorHead = cursorHead + 84
            cursorBase = cursorBase + 84
            command = command + 1
         end
      elseif key == ('return') then
         battleEvents()  
      end
   elseif mode == 2 then
      if key == ('a') then
         if selection > 0 then
            cursorBase = cursorBase - 84
            cursorHead = cursorHead - 84
            selection = selection - 1
         end
      elseif key == ('d') then
         if selection < 2 then
            cursorHead = cursorHead + 84
            cursorBase = cursorBase + 84
            selection = selection + 1
         end
      elseif key == ('return') then
         menuEvents()
      end
   end
end

function drawMap()
   for y=1, SCREEN_SIZE do
      for x=1, SCREEN_SIZE do                                                         
         love.graphics.draw(tile[map[y+mapY][x+mapX]], (x*TILE_SIZE), (y*TILE_SIZE))
      end
   end
end

function drawBattle()
   for y=1, SCREEN_SIZE do
      for x=1, SCREEN_SIZE do
         love.graphics.draw(tile[battle[y][x]], (x*TILE_SIZE), (y*TILE_SIZE))
      end
   end
   love.graphics.draw(battleFrame, 4*TILE_SIZE, 2.25*TILE_SIZE)
   love.graphics.rectangle("line",34,344,9*TILE_SIZE, 24)
   love.graphics.draw(enemies[enemy].image, 5*TILE_SIZE, 4*TILE_SIZE)
   for i = 1, 3 do 
      love.graphics.print(battleMenu[i], 84*i, 350)
   end
   love.graphics.polygon("fill", cursorBase, 352, cursorHead, 356, cursorBase, 360)
   love.graphics.print("OPHP: "..enemies[enemy].health, 255, 5)
end

function drawMenu()
   love.graphics.rectangle("line",34,344,9*TILE_SIZE, 24)
   for i = 1, 3 do
      love.graphics.print(worldMenu[i], 84*i, 350)
   end
   love.graphics.polygon("fill", cursorBase, 352, cursorHead, 356, cursorBase, 360)
end

function drawHero()
   if hero.imageSwitch == 0 then
      love.graphics.draw(hero.imageLeft, 5*TILE_SIZE, 5*TILE_SIZE)
   else
      love.graphics.draw(hero.imageRight, 5*TILE_SIZE, 5*TILE_SIZE)
   end
end

function love.draw()
   love.graphics.setFont(defaultFont)
   love.graphics.scale(2)
   if mode == 0 then
      drawMap()
      drawHero()
   elseif mode == 1 then
      drawBattle()
   elseif mode == 2 then
      drawMap()
      drawMenu()
      drawHero()
   end
   love.graphics.rectangle("line",TILE_SIZE,3,9*TILE_SIZE, 28)
   love.graphics.print("LVL: "..hero.level,      40,  5)
   love.graphics.print("EXP: "..hero.experience, 40, 17)
   love.graphics.print("HP: "..hero.health.."/"..hero.healthMax, 150,  5)
   love.graphics.print("MP: "..hero.magics.."/"..hero.magicMax,  150, 17)
   love.graphics.print("ATK: "..hero.attacks, 96,  5)
   love.graphics.print("DEF: "..hero.defense, 96, 17)
   love.graphics.print("GOLD: "..hero.gold, 255, 17)
end

function love.update(dt)
   if mode == 0 then
      hero.imageTimer = hero.imageTimer + dt
      if hero.imageTimer > 0.4 then
         if hero.imageSwitch == 0 then
            hero.imageSwitch = 1
         else
            hero.imageSwitch = 0
         end
      hero.imageTimer = 0
      end
   end
end